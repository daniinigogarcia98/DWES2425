<!DOCTYPE html>
<html lang="en">
  <head>
    <title>tienda</title>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css" />
  </head>
  <body>
    <div class="container">
      <div class="row mt-2">
        <h3 class="text-center" id="nombreUS"></h3>
      </div>
    </div>
    <br/>
    <div class="d-flex">
      <h4>Productos</h4>
      <table class="table table-striped" id="productos">
       
      </table>
    </div>
    <div class="d-flex">
      <h1>Pedidos</h1>
      <table class="table table-striped" id="pedidos">
       
       
      </table>
    </div>
    <button type="button" class="btn btn-primary" onclick="salir()">Salir</button>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="js/jquery-3.6.0.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="axios/dist/axios.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Recuperar token
        const token = localStorage.getItem('token');
        if (token == null) {
          window.location.href = "login.html";
        } else {
          const nombreUS = localStorage.getItem('us');
          document.getElementById('nombreUS').textContent = `${nombreUS}`;
        }

        // Todas las peticiones van a ir con token de autenticación
        axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;

        cargarProductos();
        cargarPedidos();
        function cargarPedidos(){
        const url = 'http://localhost/DWES2425/U5/APITienda/public/api/pedidos'
        axios.get(url)
        .then(response=>{
            console.log(response.data)
            var pedidos = response.data.data;
            var tablaP = document.getElementById('pedidos');
            tablaP.innerHTML=
            '<tr><td scope="col">ID</td><td scope="col">Producto</td><td scope="col">Cantidad</td><td scope="col">Precio Unitario</td><td scope="col">Imagen</td><td scope="col">Acciones</td></tr>'
            pedidos.forEach(p => {
                var fila = document.createElement('tr')
                fila.innerHTML = `<td>${p.id}</td>
                    <td>${p.producto}</td>
                    <td>${p.cantidad}</td>
                    <td>${p.precioU}</td>
                    <td><img src="http://localhost/DWES2425/U4/tienda/public/img/productos/${p.imagen}" width="40px"/></td>`
                tablaP.appendChild(fila);
            });  
        })
        .catch(error=>{
            console.error(error)
            alert('Error:'+error.status+' '+error.response.data)
        });
    }
    function comprar(id) {
        const url = 'http://localhost/DWES2425/U5/APITienda/public/api/pedidos'
        const datos = {
            producto:id,
            cantidad:1
        }
        axios.post(url,datos)
        .then(response=>{
           alert('Pedido creado');
           cargarProductos();
           cargarPedidos();          
        })
        .catch(error=>{
            console.error(error)
            alert('Error:'+error.status+' '+error.response.data)
        });
    }
    function cargarProductos(){
        const url = 'http://localhost/DWES2425/U5/APITienda/public/api/productos'
        axios.get(url)
        .then(response=>{
            
          var productos = response.data;
          var tablaP = document.getElementById('productos');
          tablaP.innerHTML=
          '<tr><td scope="col">ID</td><td scope="col">Nombre</td><td scope="col">Precio</td><td scope="col">Stock</td><td scope="col">Imagen</td><td scope="col">Acciones</td></tr>'
          productos.forEach(p => {
            var fila = document.createElement('tr')
            fila.innerHTML = `<td>${p.id}</td>
                <td>${p.nombre}</td>
                <td>${p.precio}</td>
                <td>${p.stock}</td>
                <td><img src="http://localhost/DWES2425/U4/tienda/public/img/productos/${p.imagen}" width="40px"/></td>
                <td><button type="button" onclick="comprar(${p.id})">Comprar</button></td>`
            tablaP.appendChild(fila);
          }); 
        })
        .catch(error=>{
            console.error(error)
            alert('Error al cargar los productos');
        });
    }
        function salir() {
          const url = 'http://localhost/DWES2425/U5/APITienda/public/api/logout';
          axios.post(url)
            .then(response => {
              alert('Sesión cerrada');
              window.location.href = "login.html";
              localStorage.removeItem('token');
              localStorage.removeItem('us');
            })
            .catch(error => {
              alert('Error: no se ha podido cerrar la sesión');
            });
        }
      });
              

    </script>
  </body>
</html>
